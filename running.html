<html><head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script><style type="text/css">/* Chart.js */
  @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
  @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
  @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style>

<style>
  body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0078d7, #f2f3f4);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 95vh;
      margin: 0;
      padding: 20px;
      color: #333;
    }
</style>
</head>

<body style="
    height: 100VH;
    margin: 0;
    overflow: hidden;
">
  <!-- Â∑¶ÊâãÈ¶ñ„ÇíÊ§úÁü•„Åó„ÄÅËµ§„ÅÑÊû†„ÅßËøΩ„ÅÑ„Åã„Åë„Çã„ÉªÂè≥ÊâãÈ¶ñ„ÇíÊ§úÁü•„Åó„ÄÅÈùí„ÅÑÊû†„ÅßËøΩ„ÅÑ„Åã„Åë„Çã -->
  
  <div id="maru"
      style="font-size:80px; position: fixed; top:33%; left:77%;
          transform: translate(-50%, -50%); color:red; display:none; z-index:99999;">
  </div>

  <div id="batu"
      style="font-size:80px; position: fixed; top:33%; left:77%;
          transform: translate(-50%, -50%); color:blue; display:none; z-index:99999;">
  </div>


  <div style="display:flex;flex-direction: column;height: 95%; gap: 10px;">
    <h2 style="
      height: 60px;
      line-height: 60px;
      font-size: 28px;
      width: 100%;
      background: linear-gradient(to right, #003366);
      text-align: center;
      color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      margin: 0;
      font-weight: bold;
    ">Ë®àÁÆó„É©„É≥„Éã„É≥„Ç∞</h2>
    <div style="display:flex;height: 12%;background-color: white;gap: 30px;border: 1px solid black;border-radius: 10px;">
      <div style="display: flex; gap: 10px; align-items: center;padding:20px;font-size: 20px;">
        <div>ÊÆã„ÇäÊôÇÈñì</div>
        <div id="countDown" style="border: 1px solid black; width: 200px; height: 30px;place-content:center;padding-left: 10px;"></div>
      </div>
      <div style="align-items: center; display: flex; gap: 10px;font-size: 20px;">
        <div>Áç≤ÂæóÁÇπÊï∞</div>
        <div id="scoreShow" style="border: 1px solid black; width: 200px; height: 30px;place-content:center;padding-left: 10px;"></div>
      </div>
    </div>
    <div style="display:flex;height: 30%;align-items: center;justify-content: center;gap: 20px;padding: 20px; border: 1px solid black;background-color: white;border-radius: 10px;">
      <div id="question" style="font-size: 60px;height: 80%;width: 70%;margin-left: 20px;text-align: center;align-content: center;"></div>
      <div id="number_result" style="font-size: 57px; position:relative; font-size:60px;height: 80%;width: 30%;border: 1px solid black; align-content: center; text-align-last: center;"></div>
    </div>
    <div style="display: flex;height: 15%;align-items: center; border: 1px solid black;background-color: white;padding: 20px;border-radius: 10px;">
      <div id="fullVoice_result" style="margin-left: 20px;font-size: 40px;"></div>
    </div>
    <div style="display:flex;height: 30%; gap: 5px;background-color: white;border-radius: 10px;padding:20px">
      <div id="graph" style="width:30%; border: 1px solid black;background-color: white;">
        <div class="graph" style="width: 100%; max-width: 600px; height: 300px; margin: 0 auto;"></div>
        <canvas id="chart" width="450" height="225" style="display: block; height: 100%; width: 100%;justify-content: center; align-items: center;"></canvas>
      </div>
      <div id="movie" style="width:40%; place-items: center;">
        <div id="video_parent">
          <video id="video" style="position: relative; z-index:1;" autoplay="" playsinline=""></video>
          <div id="left_rect" style="position: absolute; z-index: 10; width: 30px; height: 30px; border: 2px solid transparent; top: 809.925px; left: 426.338px;"></div>
          <div id="right_rect" style="position: absolute; z-index: 10; width: 30px; height: 30px; border: 2px solid transparent; top: 807.448px; left: 338.259px;"></div>
        </div>
      </div>
      <div id="detail" style="
        width: 30%;
        border: 1px solid black;
        background-color: white;
        font-size: 20px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        height: 91%; /* ÂøÖË¶Å„Å´Âøú„Åò„Å¶È´ò„Åï„ÇíË™øÊï¥ */
      ">
        <div id="distanceshow"></div>
        <div id="speed"></div>
        <div style="flex-grow: 1;"></div>
        <button id="TOP" style="
          padding: 12px 30px;
          font-size: 18px;
          background: #0078d7;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: background 0.3s;
          align-self: flex-end; /* Âè≥ÂØÑ„Åõ */
        ">
          TOPÁîªÈù¢„Å∏Êàª„Çã
        </button>
      </div>

  </div>


  <script>

    const questionDiv = document.getElementById('question');
    const answerDiv = document.getElementById('answer');
    const maruDiv = document.getElementById('maru');
    const batuDiv = document.getElementById('batu');
    let questionWait = false;
    let detector, video;
    let lastY = null, moveCount = 0;
    let whichUp = 0;		//0:Left Up, 1:Right Up
    let changeCount = 0;
    let totalCount = 0;
    let distance = 0;
    let leftWristScore = -1;
    let rightWristScore = -1;
    let leftWristY = -1;
    let rightWristY = -1;
    let startTime = 0;
    let nowTime = 0;
    let b = null;
    let c = null;
    // ÂïèÈ°åÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åô„ÇãÂ§âÊï∞
    let questionCount = 0;
    // Ê≠£Á≠îÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åô„ÇãÂ§âÊï∞
    let score = 0;
    let flag = false;
    let quizflag = false;

    //5ÂàÜ„ÇíÊ∏¨„Çã„Åü„ÇÅ„ÅÆÂ§âÊï∞
    let startTime5 = 0;
    let timeflag = 0;
    let counttime = 0;
    let x = 0;
    let m = 0;
    let s = 0;
    let lastDistance = 0;
    let previousCount = 0;  // ÂâçÂõûË®àÊ∏¨ÊôÇ„ÅÆ totalCount
    let lastSpeed = 0;      // ÊúÄÂæå„Å´Ë®àÁÆó„Åó„ÅüÈÄüÂ∫¶Ôºàkm/hÔºâ
    let scoreFlag = 0;
    let questionType = localStorage.getItem('questionType');
    let questionText = "";
    const store = {};
    


    async function init() {
      // „Ç´„É°„É©ÂèñÂæó
      video = document.getElementById('video');
      const constraints = {
        video:{
          width:{ideal:320},
          height:{ideal:240}
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // MoveNet„É≠„Éº„Éâ
      detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);

      // Êé®ÂÆö„É´„Éº„ÉóÈñãÂßã
      detect();
    }

    const age = Number(localStorage.getItem('age'));
        if(age == 25){
          MaxHr = 200;
        }else if(age == 35){
          MaxHr = 190;
        }else if(age == 45){
          MaxHr = 180;
        }else if(age == 55){
          MaxHr = 170;
        }else if(age == 65){
          MaxHr = 160;
        }

      // 1Áßí„Åî„Å®„Å´ÈÄüÂ∫¶„Å®ÂøÉÊãçÊï∞„ÇíÊõ¥Êñ∞
      setInterval(() => {
        // ‰ªä„ÅÆ„Éà„Éº„Çø„É´„ÅÆËÖïÊåØ„ÇäÂõûÊï∞
        const currentCount = totalCount;

        // „Åì„ÅÆ1ÁßíÈñì„Å´Â¢ó„Åà„ÅüÂõûÊï∞
        const deltaCount = currentCount - previousCount;
        previousCount = currentCount;

        // 1„Çπ„ÉÜ„ÉÉ„Éó„ÅÇ„Åü„Çä 0.8m „Å®‰ªÆÂÆöÔºàÂ∑¶Âè≥ÂÖ•„ÇåÊõø„Åà1Âõû = 0.8mÔºâ
        const distancePerStepMeters = 0.8;

        // „Åì„ÅÆ1ÁßíÈñì„ÅÆÁßªÂãïË∑ùÈõ¢ÔºàmÔºâ
        const distanceThisSecondMeters = deltaCount * distancePerStepMeters;

        // 1ÁßíÈñì„Å™„ÅÆ„Åß„ÄÅ„Åù„ÅÆ„Åæ„Åæ m/s
        const speedMps = distanceThisSecondMeters; // /1 „ÅØÁúÅÁï•

        // km/h „Å´Â§âÊèõ
        const speedKmh = speedMps * 3.6;
        lastSpeed = speedKmh;

        // ÈÄüÂ∫¶Ë°®Á§∫
        if(speedKmh >= 20){
          document.getElementById('speed').innerText =
            "ÊôÇÈÄüÔºö 20 km/h";
        }else if (speedKmh > 0) {
          document.getElementById('speed').innerText =
            "ÊôÇÈÄüÔºö " + speedKmh.toFixed(2) + " km/h";
        } else {
          document.getElementById('speed').innerText =
            "ÊôÇÈÄüÔºö 0.00 km/h";
        }

        
        // ÂøÉÊãçÊï∞Êé®ÂÆö
          if(speedKmh >= 20){
            heartRate = MaxHr;
          }else if(speedKmh >= 15){
            heartRate = MaxHr * 0.9;
          }else if(speedKmh >= 12){
            heartRate = MaxHr * 0.8;
          }else if(speedKmh >= 10){
            heartRate = MaxHr * 0.7;
          }else if(speedKmh >= 8){
            heartRate = MaxHr * 0.6;
          }else if(speedKmh < 7){
            if(speedKmh == 0){
              heartRate = 60;
            }else{
              heartRate = MaxHr * 0.5;
            }
          }
        

        // „Ç∞„É©„Éï„Å´ËøΩÂä†
        const chartData = store.chart.data.datasets[0].data;
        if (chartData.length > 100) {
          chartData.shift();
        }
        chartData.push(heartRate);

        store.chart.update();

      }, 1000);

    function startTimer() {
      if (startTime5 === 0) {
        startTime5 = performance.now();
      }
      // 1Áßí„Åî„Å®„Å´Êõ¥Êñ∞
      timer = setInterval(time, 1000);
    }

    //ÊôÇÈñì„ÇíÊ∏¨„ÇãÈñ¢Êï∞
    function time() {
      const minutes = Number(localStorage.getItem('minutes'));
      const now = performance.now();
      //ÁµåÈÅéÊôÇÈñì
      counttime = now - startTime5;
      //ÊÆã„ÇäÊôÇÈñì
      const countDown = Math.max(minutes - counttime, 0);

      x = Math.ceil(countDown / 1000);
      m = Math.floor(x / 60);
      s = x % 60;
      document.getElementById('countDown').innerText = m + " ÂàÜ" + s + " Áßí";

      document.getElementById('elapsed').innerText =
        "ÁµåÈÅé " + Math.floor(counttime / 60000) + " ÂàÜ" + Math.floor((counttime % 60000) / 1000) + " Áßí";




      if (counttime >= minutes) {
        timeflag = 1;
        clearInterval(timer); // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
      }

      if (countDown == 0) {
        localStorage.setItem('minutes', minutes);
        localStorage.setItem('distance', distance);
        localStorage.setItem('score', score);
        window.location.href = 'result.html';
      }
    }


    async function detect() {
      const poses = await detector.estimatePoses(video);
      document.getElementById('poses').innerText = poses.length;
      if (poses.length > 0) {
        const keypoints = poses[0].keypoints;


        document.getElementById('current_count').innerText = changeCount;
        startTimer();
        if (startTime == 0) {
          startTime = performance.now();
        }

        if (questionCount == 0 && !questionWait) {
          await generateQuestion(true);
        }

        nowTime = performance.now();
        /*ifÔºàÁèæÂú®„ÅÆÁµåÈÅéÊôÇÈñì„Åã„ÇâË®àÊ∏¨„ÇíÈñãÂßã„Åó„ÅüÊôÇÈñì„Åå1Áßí‰ª•ÂÜÖÔºà1000„Éü„É™ÁßíÔºâÔºâ*/
        if (nowTime - startTime > 1000) {
          let txt = "Ê≠¢„Åæ„Å£„Å¶„Çã";
          flag = false;
          if (changeCount >= 3) {
            txt = "Ëµ∞„Å£„Å¶„Çã";
            flag = true;
          } else if (changeCount >= 1) {
            txt = "Ê≠©„ÅÑ„Å¶„Çã";
            flag = false;
          }

          document.getElementById('current_status').innerText = txt;
          startTime = 0;
          changeCount = 0;
          // detect() „ÅÆ‰∏≠„ÅÆ„ÇØ„Ç§„Ç∫Âá∫È°åÈÉ®ÂàÜ„Çí1ÂïèÁõÆ„Å†„Åë
          console.log("flag:" + flag)
          console.log("questionCount:" + questionCount);
          if (flag) {
            time();
            if (questionCount == 0) {
              await generateQuestion();
            } else if (questionCount >= 1) {
              if(questionType == "calc1"){
                questionDiv.innerText = `${a} + ${b} =`;
              }else if(questionType == "calc2"){
                questionDiv.innerText = `${a} √ó ${b} =`;
              }
            }
          } else {
            questionDiv.innerText = "Ëµ∞„Å£„Å¶„Åè„Å†„Åï„ÅÑ";
          }
        }

        let videoObj = document.getElementById('video_parent').getBoundingClientRect();
        /*Â∑¶ÊâãÈ¶ñ*/
        const lw = keypoints.find(p => p.name === 'left_wrist');
        if (lw) {
          document.getElementById('div_left_wrist').innerText = lw.y;
          document.getElementById('div_left_diff').innerText = Math.abs(leftWristY - lw.y);
          leftWristScore = lw.score;
          leftWristY = lw.y;
          let leftRect = document.getElementById('left_rect');
          /*Â∑¶ÊâãÈ¶ñ„ÅÆyÂ∫ßÊ®ôÔºàÈ´ò„ÅïÔºâ*/
          leftRect.style.top = videoObj.top + lw.y + "px";
          /*Â∑¶ÊâãÈ¶ñ„ÅÆxÂ∫ßÊ®ôÔºàÊ®™Ôºâ*/
          leftRect.style.left = videoObj.left + lw.x + "px";
        }

        /*Âè≥ÊâãÈ¶ñ*/
        const rw = keypoints.find(p => p.name === 'right_wrist');
        if (rw) {
          document.getElementById('div_right_wrist').innerText = rw.y;
          document.getElementById('div_right_diff').innerText = Math.abs(rightWristY - rw.y);
          rightWristScore = rw.score;
          rightWristY = rw.y;
          let rightRect = document.getElementById('right_rect');
          /*Âè≥ÊâãÈ¶ñ„ÅÆyÂ∫ßÊ®ôÔºàÈ´ò„ÅïÔºâ*/
          rightRect.style.top = videoObj.top + rw.y + "px";
          /*Âè≥ÊâãÈ¶ñ„ÅÆxÂ∫ßÊ®ôÔºàÊ®™Ôºâ*/
          rightRect.style.left = videoObj.left + rw.x + "px";
        }

        /*whichup=0ÔºàÂ∑¶Êâã„Åå‰∏äÔºâ
          whichup=1ÔºàÂè≥Êâã„Åå‰∏äÔºâ*/

        /*Âè≥Êâã„Åå‰∏ä„Åã„Å§whichup=0 „Åæ„Åü„ÅØ Â∑¶Êâã„Åå‰∏ä„Åã„Å§whichup=1„ÅÆÂ†¥Âêà„ÄÅ1Âõû„Å®„Ç´„Ç¶„É≥„Éà„Åô„ÇãÔºàÂ∑¶Âè≥„ÅåÂÖ•„ÇåÊõø„Çè„ÇãÂ†¥ÂêàÔºâ*/
        if (lw && rw) {
          if ((rightWristY > leftWristY && whichUp == 0) ||
            (rightWristY < leftWristY && whichUp == 1)) {
            changeCount++;
            totalCount++;
          }
          whichUp = rightWristY < leftWristY ? 0 : 1;
        }



        //Ëµ∞Ë°åË∑ùÈõ¢„ÇíË®àÁÆóÔºàcmÔºâ
        distance = totalCount * 80
        let changedistance;
        //Ëµ∞Ë°åË∑ùÈõ¢„Åå1km‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÄÅkm„ÅßÂ∞èÊï∞Á¨¨2„Åæ„Åß„ÇíË°®Á§∫
        if (distance >= 100000) {
          // 100000cm = 1km
          changedistance = distance / 100000;
          document.getElementById('distanceshow').innerText = "Ëµ∞Ë°åË∑ùÈõ¢Ôºö" + changedistance.toFixed(2) + " km";
          //Ëµ∞Ë°åË∑ùÈõ¢„Åå1kmÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÄÅm„ÅßÂ∞èÊï∞Á¨¨2„Åæ„Åß„ÇíË°®Á§∫
        } else {
          // 100cm = 1m
          changedistance = distance / 100;
          document.getElementById('distanceshow').innerText = "Ëµ∞Ë°åË∑ùÈõ¢Ôºö" + changedistance.toFixed(2) + " m";
        }


      }
      requestAnimationFrame(detect);
    }

    document.getElementById('TOP').addEventListener('click', () => {
      window.location.href = 'top.html';
    });


    // Èü≥Â£∞Ë™çË≠ò„ÅÆÂàùÊúüÂåñ
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ja-JP'; // Êó•Êú¨Ë™û
    recognition.interimResults = false; // Á¢∫ÂÆöÁµêÊûú„ÅÆ„Åø
    recognition.continuous = true; // Â∏∏ÊôÇË™çË≠ò

    // Èü≥Â£∞Ë™çË≠ò„ÅÆÁµêÊûú„ÇíÂèó„ÅëÂèñ„Çã
    recognition.onresult = function(event) {
      const last = event.results.length - 1;
      const transcript = event.results[last][0].transcript.trim().replace(/„ÄÇ+$/, "");
      
      const fullText = transcript;
      const converted = fullText.split("").map(ch => kanjiToDigit[ch] ?? ch).join("");
      const onlyNumber = converted.match(/\d+/)?.[0] ?? "";

      console.log("ÂÖ®Êñá:", fullText);
      console.log("Êï∞Â≠ó„Å†„Åë:", onlyNumber);

      checkAnswer(onlyNumber, fullText);
    };

    // ‚ë°Êº¢Êï∞Â≠ó„Çí„Ç¢„É©„Éì„Ç¢Êï∞Â≠ó„Å´Â§âÊèõ
      const kanjiToDigit = {
        "‰∏Ä": "1", "‰∫å": "2", "‰∏â": "3", "Âõõ": "4", "‰∫î": "5",
        "ÂÖ≠": "6", "‰∏É": "7", "ÂÖ´": "8", "‰πù": "9",
        "ÂçÅ": "10", "Áôæ": "100"
      };


    // Èü≥Â£∞Ë™çË≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜ
    recognition.onerror = function (event) {
      console.error("‚ùå Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:", event.error);
    };

    recognition.onend = () => {
      console.log("üîÅ Èü≥Â£∞Ë™çË≠ò„ÅåÁµÇ‰∫Ü„Åó„Åü„ÅÆ„ÅßÂÜçÈñã„Åó„Åæ„Åô");
      recognition.start();
    };

    // Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã„Åô„ÇãÈñ¢Êï∞
    function startListening() {
      recognition.start();
      console.log("üé§ Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü");
    }

    startListening();

    // „ÇØ„Ç§„Ç∫Âá∫È°åÈñ¢Êï∞
    async function generateQuestion(isFast = false) {
      questionWait = true;
      setTimeout(( ) => {
        const difficulty = localStorage.getItem('difficulty');
        const questionType = localStorage.getItem('questionType');
        console.log(questionType);
        if(questionType == "calc1"){
          if (difficulty == "hard") {
            quizflag = Math.random();
            if(quizflag >= 0.8){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 90) + 10;
              scoreFlag = 3;
            }else if(quizflag >= 0.4){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 2;
            }else{
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            }
          }else if (difficulty == "normal") {
            quizflag = Math.random() < 0.5;
            if (quizflag) {
              //1Ê°Å√ó1Ê°Å
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            } else {
              //2Ê°Å√ó1Ê°Å
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 2;
            }
            
          }else if (difficulty == "easy") {
            a = Math.floor(Math.random() * 9) + 1;
            b = Math.floor(Math.random() * 9) + 1;
            scoreFlag = 1;
          }
          c = a + b;
          questionText = `${a} + ${b} =`;
          questionDiv.innerText = questionText;
          speak(questionText);
        }
        if(questionType == "calc2"){
          if (difficulty == "hard") {
            quizflag = Math.random();
            if(quizflag >= 0.8){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 90) + 10;
              scoreFlag = 5;
            }else if(quizflag >= 0.4){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 3;
            }else{
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            }
          }else if (difficulty == "normal") {
            quizflag = Math.random() < 0.5;
            if (quizflag) {
              //1Ê°Å√ó1Ê°Å
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            } else {
              //2Ê°Å√ó1Ê°Å
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 3;
            }
            
          }else if (difficulty == "easy") {
            a = Math.floor(Math.random() * 9) + 1;
            b = Math.floor(Math.random() * 9) + 1;
            scoreFlag = 1;
          }
          c = a * b;
          questionText = `${a} √ó ${b} =`;
          questionDiv.innerText = questionText;
          speak(questionText);
        }
        questionCount++;
      },isFast ? 1 : 1000);
    }


    // checkAnswer() „Çí‰øÆÊ≠£„Åó„Å¶„ÄÅÊ≠£Ëß£ÊôÇ„Å´Ê¨°„ÅÆÂïèÈ°å„ÇíÂá∫„Åô
    async function checkAnswer(word,pass) {

      const result = word.split("").map(ch => kanjiToDigit[ch] ?? ch).join("");

      document.getElementById('number_result').innerText = result;
      document.getElementById('fullVoice_result').innerText = pass;
      
      if (result === String(c)) {
        playPingPong();
        maruDiv.innerText = "„Äá";
        maruDiv.style.display = "block";
        console.log(maruDiv);
        if (scoreFlag == 1) {
          score++;
        } else if(scoreFlag == 3){
          score += 3;
        } else if(scoreFlag == 5){
          score += 5;
        }
        await new Promise(resolve => setTimeout(resolve, 800)); 
        maruDiv.style.display = "none";
        maruDiv.innerText = "";
        if (flag) {
          // Ê≠£Ëß£„Åó„Åü„ÇâÊ¨°„ÅÆÂïèÈ°å„ÇíÂá∫„Åô
          await generateQuestion();
        }
      } else if (pass.includes("„Éë„Çπ")) {
        //„Éë„Çπ„ÇíÂÆ£Ë®Ä„Åó„ÅüÂ†¥Âêà„ÄÅ„Çπ„Ç≥„Ç¢„Çí-1„Åó„ÄÅÂà•„ÅÆÂïèÈ°å„ÇíÂá∫È°å„Åô„Çã
        await generateQuestion();
        score--;
        console.log("„Éë„Çπ„Åó„Åæ„Åó„Åü");
      } else if(pass.includes("„Éó„É©„Çπ") || pass.includes("„Ç´„Ç±„É´")){
        
      } else if(result !== String(c)){
        if(result !== ""){
          batuDiv.innerText = "‚úñ";
          batuDiv.style.display = "block"; 
          playWrongSound();
          await new Promise(resolve => setTimeout(resolve, 800)); 
          batuDiv.style.display = "none";
          batuDiv.innerText = "";
        }else{
          await new Promise(resolve => setTimeout(resolve, 800)); 
        }
      }
      
      addQuestionCount();
      document.getElementById('fullVoice_result').innerText = "";
      document.getElementById('number_result').innerText = "";
    }
    
    

    function hideMessage() {
      score.innerText = ``;
    }

    function addQuestionCount() {
      document.getElementById('scoreShow').innerText = `${score}ÁÇπ`;
    }


    //Ê≠£Ëß£„Éª‰∏çÊ≠£Ëß£Èü≥Èñ¢Êï∞
    //„Éî„É≥„Éù„É≥Èü≥Âá∫„Åô
    function playPingPong() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      // „Éî„É≥Èü≥ÔºàÈ´ò„ÇÅÔºâ
      const pin = ctx.createOscillator();
      pin.type = 'sine';
      pin.frequency.setValueAtTime(880, ctx.currentTime); // È´òÈü≥
      pin.connect(ctx.destination);
      pin.start();
      pin.stop(ctx.currentTime + 0.2);

      // „Éù„É≥Èü≥Ôºà‰Ωé„ÇÅÔºâ
      const pong = ctx.createOscillator();
      pong.type = 'sine';
      pong.frequency.setValueAtTime(440, ctx.currentTime + 0.3); // ‰ΩéÈü≥
      pong.connect(ctx.destination);
      pong.start(ctx.currentTime + 0.3);
      pong.stop(ctx.currentTime + 0.5);
    }

    function playWrongSound() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      // „ÉñÈü≥Ôºà‰Ωé„ÇÅÔºâ
      const bu1 = ctx.createOscillator();
      bu1.type = 'square';
      bu1.frequency.setValueAtTime(220, ctx.currentTime); // ‰ΩéÈü≥
      bu1.connect(ctx.destination);
      bu1.start();
      bu1.stop(ctx.currentTime + 0.2);

      // „ÉñÈü≥Ôºà„ÇÇ„ÅÜ‰∏ÄÁô∫Ôºâ
      const bu2 = ctx.createOscillator();
      bu2.type = 'square';
      // Âêå„ÅòÈü≥„ÇíÂ∞ë„ÅóÈÅÖ„Çå„Å¶
      bu2.frequency.setValueAtTime(220, ctx.currentTime + 0.3);
      bu2.connect(ctx.destination);
      bu2.start(ctx.currentTime + 0.3);
      bu2.stop(ctx.currentTime + 0.5);
    }


    const synth = window.speechSynthesis;
    const voiceSelect = document.getElementById("voiceSelect");

    // Âà©Áî®ÂèØËÉΩ„Å™Â£∞„ÇíË™≠„ÅøËæº„ÇÄ
    function loadVoices() {
      const voices = synth.getVoices();
      voiceSelect.innerHTML = "";

      voices.forEach((voice, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
    }

    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    // Ë™≠„Åø‰∏ä„ÅíÂá¶ÁêÜ
    function speak(text) {
      // recognition.stop();

      const rate = document.getElementById("rate").value;
      const selectedVoice = synth.getVoices()[voiceSelect.value];

      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = rate;
      utter.voice = selectedVoice;

      // utter.onend = () => {
      //   recognition.start();
      // };

      synth.speak(utter);
    }

    

          store.chart = new Chart(document.querySelector('#chart').getContext('2d'), {
            type: 'line',
            data: {
              labels: Array(100),
              datasets: [{
                label: 'Heart Rate (bpm)',
                backgroundColor: '#f55',
                borderColor: '#f55',
                fill: false,
                data: []
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              duration: 300,
              scales: {
                yAxes: [
                  {
                    ticks: {
                      min: 60,
                      max: 200,
                      stepSize: 10
                    }
                  }
                ]
              }
            }
          });

          function updateChart(newValue) {
            const chart = store.chart;
            const maxPoints = 100;

            // „É©„Éô„É´„Å®„Éá„Éº„Çø„ÇíËøΩÂä†
            chart.data.labels.push("");
            chart.data.datasets[0].data.push(newValue);

            // ÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„Åü„ÇâÂÖàÈ†≠„ÇíÂâäÈô§
            if (chart.data.labels.length > maxPoints) {
              chart.data.labels.shift();
              chart.data.datasets[0].data.shift();
            }

            chart.update();
          }



    init();
  </script>


</body></html>