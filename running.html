<html><head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script><style type="text/css">/* Chart.js */
  @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
  @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
  @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style>

<style>
  body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0078d7, #f2f3f4);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 95vh;
      margin: 0;
      padding: 20px;
      color: #333;
    }
</style>
</head>

<body style="
    height: 100VH;
    margin: 0;
    overflow: hidden;
">
  <!-- å·¦æ‰‹é¦–ã‚’æ¤œçŸ¥ã—ã€èµ¤ã„æ ã§è¿½ã„ã‹ã‘ã‚‹ãƒ»å³æ‰‹é¦–ã‚’æ¤œçŸ¥ã—ã€é’ã„æ ã§è¿½ã„ã‹ã‘ã‚‹ -->
  
  <div id="maru"
      style="font-size:80px; position: fixed; top:33%; left:77%;
          transform: translate(-50%, -50%); color:red; display:none; z-index:99999;">
  </div>

  <div id="batu"
      style="font-size:80px; position: fixed; top:33%; left:77%;
          transform: translate(-50%, -50%); color:blue; display:none; z-index:99999;">
  </div>


  <div style="display:flex;flex-direction: column;height: 95%; gap: 10px;">
    <h2 style="
      height: 60px;
      line-height: 60px;
      font-size: 28px;
      width: 100%;
      background: linear-gradient(to right, #003366);
      text-align: center;
      color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      margin: 0;
      font-weight: bold;
    ">è¨ˆç®—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°</h2>
    <div style="display:flex;height: 12%;background-color: white;gap: 30px;border: 1px solid black;border-radius: 10px;">
      <div style="display: flex; gap: 10px; align-items: center;padding:20px;font-size: 20px;">
        <div>æ®‹ã‚Šæ™‚é–“</div>
        <div id="countDown" style="border: 1px solid black; width: 200px; height: 30px;place-content:center;padding-left: 10px;"></div>
      </div>
      <div style="align-items: center; display: flex; gap: 10px;font-size: 20px;">
        <div>ç²å¾—ç‚¹æ•°</div>
        <div id="scoreShow" style="border: 1px solid black; width: 200px; height: 30px;place-content:center;padding-left: 10px;"></div>
      </div>
    </div>
    <div style="display:flex;height: 30%;align-items: center;justify-content: center;gap: 20px;padding: 20px; border: 1px solid black;background-color: white;border-radius: 10px;">
      <div id="question" style="font-size: 60px;height: 80%;width: 70%;margin-left: 20px;text-align: center;align-content: center;"></div>
      <div id="number_result" style="font-size: 57px; position:relative; font-size:60px;height: 80%;width: 30%;border: 1px solid black; align-content: center; text-align-last: center;"></div>
    </div>
    <div style="display: flex;height: 15%;align-items: center; border: 1px solid black;background-color: white;padding: 20px;border-radius: 10px;">
      <div id="fullVoice_result" style="margin-left: 20px;font-size: 40px;"></div>
    </div>
    <div style="display:flex;height: 30%; gap: 5px;background-color: white;border-radius: 10px;padding:20px">
      <div id="graph" style="width:30%; border: 1px solid black;background-color: white;">
        <div class="graph" style="width: 100%; max-width: 600px; height: 300px; margin: 0 auto;"></div>
        <canvas id="chart" width="450" height="225" style="display: block; height: 100%; width: 100%;justify-content: center; align-items: center;"></canvas>
      </div>
      <div id="movie" style="width:40%; place-items: center;">
        <div id="video_parent">
          <video id="video" style="position: relative; z-index:1;" autoplay="" playsinline=""></video>
          <div id="left_rect" style="position: absolute; z-index: 10; width: 30px; height: 30px; border: 2px solid transparent; top: 809.925px; left: 426.338px;"></div>
          <div id="right_rect" style="position: absolute; z-index: 10; width: 30px; height: 30px; border: 2px solid transparent; top: 807.448px; left: 338.259px;"></div>
        </div>
      </div>
      <div id="detail" style="
        width: 30%;
        border: 1px solid black;
        background-color: white;
        font-size: 20px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        height: 91%; /* å¿…è¦ã«å¿œã˜ã¦é«˜ã•ã‚’èª¿æ•´ */
      ">
        <div id="distanceshow"></div>
        <div id="speed"></div>
        <div style="flex-grow: 1;"></div>
        <button id="TOP" style="
          padding: 12px 30px;
          font-size: 18px;
          background: #0078d7;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: background 0.3s;
          align-self: flex-end; /* å³å¯„ã› */
        ">
          TOPç”»é¢ã¸æˆ»ã‚‹
        </button>
      </div>

  
  <div style="display:none;">
    <h2>å•é¡Œæ–‡</h2>
    <div id="poses"></div>
    <div style="display:flex; gap: 15px;">
      <span>å·¦æ‰‹é¦–ã®ä½ç½®:</span>
      <div id="div_left_wrist"></div>
      <div id="div_left_diff"></div>
    </div>
    <div style="display:flex; gap: 15px;">
      <span>å³æ‰‹é¦–ã®ä½ç½®:</span>
      <div id="div_right_wrist"></div>
      <div id="div_right_diff"></div>
    </div>
    <span id="current_count"></span>
    <span id="current_status">æ­¢ã¾ã£ã¦ã‚‹</span>
    <textarea id="question" rows="4" cols="40">    èµ°ã‚ŠãªãŒã‚‰ã§ã‚‚è§£ã‘ã‚‹å•é¡Œã‚’èª­ã¿ä¸Šã’ã¾ã™ã€‚
    </textarea>

    <h3>èª­ã¿ä¸Šã’é€Ÿåº¦</h3>
    <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">

    <h3>å£°ã®ç¨®é¡</h3>
    <select id="voiceSelect"><option value="0">Microsoft Ayumi - Japanese (Japan) (ja-JP)</option><option value="1">Microsoft Haruka - Japanese (Japan) (ja-JP)</option><option value="2">Microsoft Ichiro - Japanese (Japan) (ja-JP)</option><option value="3">Microsoft Sayaka - Japanese (Japan) (ja-JP)</option><option value="4">Microsoft Aria Online (Natural) - English (United States) (en-US)</option><option value="5">Microsoft Guy Online (Natural) - English (United States) (en-US)</option><option value="6">Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland) (zh-CN)</option><option value="7">Microsoft Yunyang Online (Natural) - Chinese (Mainland) (zh-CN)</option><option value="8">Microsoft HanHan Online - Chinese (Taiwan) (zh-TW)</option><option value="9">Microsoft Tracy Online - Chinese (Hong Kong) (zh-HK)</option><option value="10">Microsoft Nanami Online (Natural) - Japanese (Japan) (ja-JP)</option><option value="11">Microsoft Libby Online (Natural) - English (United Kingdom) (en-GB)</option><option value="12">Microsoft Francisca Online (Natural) - Portuguese (Brazil) (pt-BR)</option><option value="13">Microsoft Dalia Online (Natural) - Spanish (Mexico) (es-MX)</option><option value="14">Microsoft Priya Online - English (India) (en-IN)</option><option value="15">Microsoft Heather Online - English (Canada) (en-CA)</option><option value="16">Microsoft Sylvie Online (Natural) - French (Canada) (fr-CA)</option><option value="17">Microsoft Denise Online (Natural) - French (France) (fr-FR)</option><option value="18">Microsoft Katja Online (Natural) - German (Germany) (de-DE)</option><option value="19">Microsoft Ekaterina Online - Russian (Russia) (ru-RU)</option><option value="20">Microsoft Hayley Online - English (Australia) (en-AU)</option><option value="21">Microsoft Elsa Online (Natural) - Italian (Italy) (it-IT)</option><option value="22">Microsoft SunHi Online (Natural) - Korean (Korea) (ko-KR)</option><option value="23">Microsoft Hanna Online - Dutch (Netherlands) (nl-NL)</option><option value="24">Microsoft Elvira Online (Natural) - Spanish (Spain) (es-ES)</option><option value="25">Microsoft Emel Online (Natural) - Turkish (Turkey) (tr-TR)</option><option value="26">Microsoft Paulina Online - Polish (Poland) (pl-PL)</option></select>

    <div id="viewer">
      <h4>å¿ƒæ‹æ•°</h4>
      <canvas id="chart" width="480"></canvas>
      <div class="graph"></div>
      <span id="elapsed"></span>
    </div>
  </div>
</div>

  <script>

    const questionDiv = document.getElementById('question');
    const answerDiv = document.getElementById('answer');
    const maruDiv = document.getElementById('maru');
    const batuDiv = document.getElementById('batu');
    let questionWait = false;
    let detector, video;
    let lastY = null, moveCount = 0;
    let whichUp = 0;		//0:Left Up, 1:Right Up
    let changeCount = 0;
    let totalCount = 0;
    let distance = 0;
    let leftWristScore = -1;
    let rightWristScore = -1;
    let leftWristY = -1;
    let rightWristY = -1;
    let startTime = 0;
    let nowTime = 0;
    let b = null;
    let c = null;
    // å•é¡Œæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹å¤‰æ•°
    let questionCount = 0;
    // æ­£ç­”æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹å¤‰æ•°
    let score = 0;
    let flag = false;
    let quizflag = false;

    //5åˆ†ã‚’æ¸¬ã‚‹ãŸã‚ã®å¤‰æ•°
    let startTime5 = 0;
    let timeflag = 0;
    let counttime = 0;
    let x = 0;
    let m = 0;
    let s = 0;
    let lastDistance = 0;
    let previousCount = 0;  // å‰å›è¨ˆæ¸¬æ™‚ã® totalCount
    let lastSpeed = 0;      // æœ€å¾Œã«è¨ˆç®—ã—ãŸé€Ÿåº¦ï¼ˆkm/hï¼‰
    let scoreFlag = 0;
    let questionType = localStorage.getItem('questionType');
    let questionText = "";
    const store = {};
    


    async function init() {
      // ã‚«ãƒ¡ãƒ©å–å¾—
      video = document.getElementById('video');
      const constraints = {
        video:{
          width:{ideal:320},
          height:{ideal:240}
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // MoveNetãƒ­ãƒ¼ãƒ‰
      detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);

      // æ¨å®šãƒ«ãƒ¼ãƒ—é–‹å§‹
      detect();
    }

    const age = Number(localStorage.getItem('age'));
        if(age == 25){
          MaxHr = 200;
        }else if(age == 35){
          MaxHr = 190;
        }else if(age == 45){
          MaxHr = 180;
        }else if(age == 55){
          MaxHr = 170;
        }else if(age == 65){
          MaxHr = 160;
        }

      // 1ç§’ã”ã¨ã«é€Ÿåº¦ã¨å¿ƒæ‹æ•°ã‚’æ›´æ–°
      setInterval(() => {
        // ä»Šã®ãƒˆãƒ¼ã‚¿ãƒ«ã®è…•æŒ¯ã‚Šå›æ•°
        const currentCount = totalCount;

        // ã“ã®1ç§’é–“ã«å¢—ãˆãŸå›æ•°
        const deltaCount = currentCount - previousCount;
        previousCount = currentCount;

        // 1ã‚¹ãƒ†ãƒƒãƒ—ã‚ãŸã‚Š 0.8m ã¨ä»®å®šï¼ˆå·¦å³å…¥ã‚Œæ›¿ãˆ1å› = 0.8mï¼‰
        const distancePerStepMeters = 0.8;

        // ã“ã®1ç§’é–“ã®ç§»å‹•è·é›¢ï¼ˆmï¼‰
        const distanceThisSecondMeters = deltaCount * distancePerStepMeters;

        // 1ç§’é–“ãªã®ã§ã€ãã®ã¾ã¾ m/s
        const speedMps = distanceThisSecondMeters; // /1 ã¯çœç•¥

        // km/h ã«å¤‰æ›
        const speedKmh = speedMps * 3.6;
        lastSpeed = speedKmh;

        // é€Ÿåº¦è¡¨ç¤º
        if(speedKmh >= 20){
          document.getElementById('speed').innerText =
            "æ™‚é€Ÿï¼š 20 km/h";
        }else if (speedKmh > 0) {
          document.getElementById('speed').innerText =
            "æ™‚é€Ÿï¼š " + speedKmh.toFixed(2) + " km/h";
        } else {
          document.getElementById('speed').innerText =
            "æ™‚é€Ÿï¼š 0.00 km/h";
        }

        
        // å¿ƒæ‹æ•°æ¨å®š
          if(speedKmh >= 20){
            heartRate = MaxHr;
          }else if(speedKmh >= 15){
            heartRate = MaxHr * 0.9;
          }else if(speedKmh >= 12){
            heartRate = MaxHr * 0.8;
          }else if(speedKmh >= 10){
            heartRate = MaxHr * 0.7;
          }else if(speedKmh >= 8){
            heartRate = MaxHr * 0.6;
          }else if(speedKmh < 7){
            if(speedKmh == 0){
              heartRate = 60;
            }else{
              heartRate = MaxHr * 0.5;
            }
          }
        

        // ã‚°ãƒ©ãƒ•ã«è¿½åŠ 
        const chartData = store.chart.data.datasets[0].data;
        if (chartData.length > 100) {
          chartData.shift();
        }
        chartData.push(heartRate);

        store.chart.update();

      }, 1000);

    function startTimer() {
      if (startTime5 === 0) {
        startTime5 = performance.now();
      }
      // 1ç§’ã”ã¨ã«æ›´æ–°
      timer = setInterval(time, 1000);
    }

    //æ™‚é–“ã‚’æ¸¬ã‚‹é–¢æ•°
    function time() {
      const minutes = Number(localStorage.getItem('minutes'));
      const now = performance.now();
      //çµŒéæ™‚é–“
      counttime = now - startTime5;
      //æ®‹ã‚Šæ™‚é–“
      const countDown = Math.max(minutes - counttime, 0);

      x = Math.ceil(countDown / 1000);
      m = Math.floor(x / 60);
      s = x % 60;
      document.getElementById('countDown').innerText = m + " åˆ†" + s + " ç§’";

      document.getElementById('elapsed').innerText =
        "çµŒé " + Math.floor(counttime / 60000) + " åˆ†" + Math.floor((counttime % 60000) / 1000) + " ç§’";




      if (counttime >= minutes) {
        timeflag = 1;
        clearInterval(timer); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
      }

      if (countDown == 0) {
        localStorage.setItem('minutes', minutes);
        localStorage.setItem('distance', distance);
        localStorage.setItem('score', score);
        window.location.href = 'result.html';
      }
    }


    async function detect() {
      const poses = await detector.estimatePoses(video);
      document.getElementById('poses').innerText = poses.length;
      if (poses.length > 0) {
        const keypoints = poses[0].keypoints;


        document.getElementById('current_count').innerText = changeCount;
        startTimer();
        if (startTime == 0) {
          startTime = performance.now();
        }

        if (questionCount == 0 && !questionWait) {
          await generateQuestion(true);
        }

        nowTime = performance.now();
        /*ifï¼ˆç¾åœ¨ã®çµŒéæ™‚é–“ã‹ã‚‰è¨ˆæ¸¬ã‚’é–‹å§‹ã—ãŸæ™‚é–“ãŒ1ç§’ä»¥å†…ï¼ˆ1000ãƒŸãƒªç§’ï¼‰ï¼‰*/
        if (nowTime - startTime > 1000) {
          let txt = "æ­¢ã¾ã£ã¦ã‚‹";
          flag = false;
          if (changeCount >= 3) {
            txt = "èµ°ã£ã¦ã‚‹";
            flag = true;
          } else if (changeCount >= 1) {
            txt = "æ­©ã„ã¦ã‚‹";
            flag = false;
          }

          document.getElementById('current_status').innerText = txt;
          startTime = 0;
          changeCount = 0;
          // detect() ã®ä¸­ã®ã‚¯ã‚¤ã‚ºå‡ºé¡Œéƒ¨åˆ†ã‚’1å•ç›®ã ã‘
          console.log("flag:" + flag)
          console.log("questionCount:" + questionCount);
          if (flag) {
            time();
            if (questionCount == 0) {
              await generateQuestion();
            } else if (questionCount >= 1) {
              if(questionType == "calc1"){
                questionDiv.innerText = `${a} + ${b} =`;
              }else if(questionType == "calc2"){
                questionDiv.innerText = `${a} Ã— ${b} =`;
              }
            }
          } else {
            questionDiv.innerText = "èµ°ã£ã¦ãã ã•ã„";
          }
        }

        let videoObj = document.getElementById('video_parent').getBoundingClientRect();
        /*å·¦æ‰‹é¦–*/
        const lw = keypoints.find(p => p.name === 'left_wrist');
        if (lw) {
          document.getElementById('div_left_wrist').innerText = lw.y;
          document.getElementById('div_left_diff').innerText = Math.abs(leftWristY - lw.y);
          leftWristScore = lw.score;
          leftWristY = lw.y;
          let leftRect = document.getElementById('left_rect');
          /*å·¦æ‰‹é¦–ã®yåº§æ¨™ï¼ˆé«˜ã•ï¼‰*/
          leftRect.style.top = videoObj.top + lw.y + "px";
          /*å·¦æ‰‹é¦–ã®xåº§æ¨™ï¼ˆæ¨ªï¼‰*/
          leftRect.style.left = videoObj.left + lw.x + "px";
        }

        /*å³æ‰‹é¦–*/
        const rw = keypoints.find(p => p.name === 'right_wrist');
        if (rw) {
          document.getElementById('div_right_wrist').innerText = rw.y;
          document.getElementById('div_right_diff').innerText = Math.abs(rightWristY - rw.y);
          rightWristScore = rw.score;
          rightWristY = rw.y;
          let rightRect = document.getElementById('right_rect');
          /*å³æ‰‹é¦–ã®yåº§æ¨™ï¼ˆé«˜ã•ï¼‰*/
          rightRect.style.top = videoObj.top + rw.y + "px";
          /*å³æ‰‹é¦–ã®xåº§æ¨™ï¼ˆæ¨ªï¼‰*/
          rightRect.style.left = videoObj.left + rw.x + "px";
        }

        /*whichup=0ï¼ˆå·¦æ‰‹ãŒä¸Šï¼‰
          whichup=1ï¼ˆå³æ‰‹ãŒä¸Šï¼‰*/

        /*å³æ‰‹ãŒä¸Šã‹ã¤whichup=0 ã¾ãŸã¯ å·¦æ‰‹ãŒä¸Šã‹ã¤whichup=1ã®å ´åˆã€1å›ã¨ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ï¼ˆå·¦å³ãŒå…¥ã‚Œæ›¿ã‚ã‚‹å ´åˆï¼‰*/
        if (lw && rw) {
          if ((rightWristY > leftWristY && whichUp == 0) ||
            (rightWristY < leftWristY && whichUp == 1)) {
            changeCount++;
            totalCount++;
          }
          whichUp = rightWristY < leftWristY ? 0 : 1;
        }



        //èµ°è¡Œè·é›¢ã‚’è¨ˆç®—ï¼ˆcmï¼‰
        distance = totalCount * 80
        let changedistance;
        //èµ°è¡Œè·é›¢ãŒ1kmä»¥ä¸Šã®å ´åˆã€kmã§å°æ•°ç¬¬2ã¾ã§ã‚’è¡¨ç¤º
        if (distance >= 100000) {
          // 100000cm = 1km
          changedistance = distance / 100000;
          document.getElementById('distanceshow').innerText = "èµ°è¡Œè·é›¢ï¼š" + changedistance.toFixed(2) + " km";
          //èµ°è¡Œè·é›¢ãŒ1kmæœªæº€ã®å ´åˆã€mã§å°æ•°ç¬¬2ã¾ã§ã‚’è¡¨ç¤º
        } else {
          // 100cm = 1m
          changedistance = distance / 100;
          document.getElementById('distanceshow').innerText = "èµ°è¡Œè·é›¢ï¼š" + changedistance.toFixed(2) + " m";
        }


      }
      requestAnimationFrame(detect);
    }

    document.getElementById('TOP').addEventListener('click', () => {
      window.location.href = 'top.html';
    });


    // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ja-JP'; // æ—¥æœ¬èª
    recognition.interimResults = false; // ç¢ºå®šçµæœã®ã¿
    recognition.continuous = true; // å¸¸æ™‚èªè­˜

    // éŸ³å£°èªè­˜ã®çµæœã‚’å—ã‘å–ã‚‹
    recognition.onresult = function(event) {
      const last = event.results.length - 1;
      const transcript = event.results[last][0].transcript.trim().replace(/ã€‚+$/, "");
      
      const fullText = transcript;
      const converted = fullText.split("").map(ch => kanjiToDigit[ch] ?? ch).join("");
      const onlyNumber = converted.match(/\d+/)?.[0] ?? "";

      console.log("å…¨æ–‡:", fullText);
      console.log("æ•°å­—ã ã‘:", onlyNumber);

      checkAnswer(onlyNumber, fullText);
    };

    // â‘¡æ¼¢æ•°å­—ã‚’ã‚¢ãƒ©ãƒ“ã‚¢æ•°å­—ã«å¤‰æ›
      const kanjiToDigit = {
        "ä¸€": "1", "äºŒ": "2", "ä¸‰": "3", "å››": "4", "äº”": "5",
        "å…­": "6", "ä¸ƒ": "7", "å…«": "8", "ä¹": "9",
        "å": "10", "ç™¾": "100"
      };


    // éŸ³å£°èªè­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
    recognition.onerror = function (event) {
      console.error("âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:", event.error);
    };

    recognition.onend = () => {
      console.log("ğŸ” éŸ³å£°èªè­˜ãŒçµ‚äº†ã—ãŸã®ã§å†é–‹ã—ã¾ã™");
      recognition.start();
    };

    // éŸ³å£°èªè­˜ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
    function startListening() {
      recognition.start();
      console.log("ğŸ¤ éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
    }

    startListening();

    // ã‚¯ã‚¤ã‚ºå‡ºé¡Œé–¢æ•°
    async function generateQuestion(isFast = false) {
      questionWait = true;
      setTimeout(( ) => {
        const difficulty = localStorage.getItem('difficulty');
        const questionType = localStorage.getItem('questionType');
        console.log(questionType);
        if(questionType == "calc1"){
          if (difficulty == "hard") {
            quizflag = Math.random();
            if(quizflag >= 0.8){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 90) + 10;
              scoreFlag = 3;
            }else if(quizflag >= 0.4){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 2;
            }else{
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            }
          }else if (difficulty == "normal") {
            quizflag = Math.random() < 0.5;
            if (quizflag) {
              //1æ¡Ã—1æ¡
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            } else {
              //2æ¡Ã—1æ¡
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 2;
            }
            
          }else if (difficulty == "easy") {
            a = Math.floor(Math.random() * 9) + 1;
            b = Math.floor(Math.random() * 9) + 1;
            scoreFlag = 1;
          }
          c = a + b;
          questionText = `${a} + ${b} =`;
          questionDiv.innerText = questionText;
          speak(questionText);
        }
        if(questionType == "calc2"){
          if (difficulty == "hard") {
            quizflag = Math.random();
            if(quizflag >= 0.8){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 90) + 10;
              scoreFlag = 5;
            }else if(quizflag >= 0.4){
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 3;
            }else{
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            }
          }else if (difficulty == "normal") {
            quizflag = Math.random() < 0.5;
            if (quizflag) {
              //1æ¡Ã—1æ¡
              a = Math.floor(Math.random() * 9) + 1;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 1;
            } else {
              //2æ¡Ã—1æ¡
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * 9) + 1;
              scoreFlag = 3;
            }
            
          }else if (difficulty == "easy") {
            a = Math.floor(Math.random() * 9) + 1;
            b = Math.floor(Math.random() * 9) + 1;
            scoreFlag = 1;
          }
          c = a * b;
          questionText = `${a} Ã— ${b} =`;
          questionDiv.innerText = questionText;
          speak(questionText);
        }
        questionCount++;
      },isFast ? 1 : 1000);
    }


    // checkAnswer() ã‚’ä¿®æ­£ã—ã¦ã€æ­£è§£æ™‚ã«æ¬¡ã®å•é¡Œã‚’å‡ºã™
    async function checkAnswer(word,pass) {

      const result = word.split("").map(ch => kanjiToDigit[ch] ?? ch).join("");

      document.getElementById('number_result').innerText = result;
      document.getElementById('fullVoice_result').innerText = pass;
      
      if (result === String(c)) {
        playPingPong();
        maruDiv.innerText = "ã€‡";
        maruDiv.style.display = "block";
        console.log(maruDiv);
        if (scoreFlag == 1) {
          score++;
        } else if(scoreFlag == 3){
          score += 3;
        } else if(scoreFlag == 5){
          score += 5;
        }
        await new Promise(resolve => setTimeout(resolve, 800)); 
        maruDiv.style.display = "none";
        maruDiv.innerText = "";
        if (flag) {
          // æ­£è§£ã—ãŸã‚‰æ¬¡ã®å•é¡Œã‚’å‡ºã™
          await generateQuestion();
        }
      } else if (pass.includes("ãƒ‘ã‚¹")) {
        //ãƒ‘ã‚¹ã‚’å®£è¨€ã—ãŸå ´åˆã€ã‚¹ã‚³ã‚¢ã‚’-1ã—ã€åˆ¥ã®å•é¡Œã‚’å‡ºé¡Œã™ã‚‹
        await generateQuestion();
        score--;
        console.log("ãƒ‘ã‚¹ã—ã¾ã—ãŸ");
      } else if(pass.includes("ãƒ—ãƒ©ã‚¹") || pass.includes("ã‚«ã‚±ãƒ«")){
        
      } else if(result !== String(c)){
        if(result !== ""){
          batuDiv.innerText = "âœ–";
          batuDiv.style.display = "block"; 
          playWrongSound();
          await new Promise(resolve => setTimeout(resolve, 800)); 
          batuDiv.style.display = "none";
          batuDiv.innerText = "";
        }else{
          await new Promise(resolve => setTimeout(resolve, 800)); 
        }
      }
      
      addQuestionCount();
      document.getElementById('fullVoice_result').innerText = "";
      document.getElementById('number_result').innerText = "";
    }
    
    

    function hideMessage() {
      score.innerText = ``;
    }

    function addQuestionCount() {
      document.getElementById('scoreShow').innerText = `${score}ç‚¹`;
    }


    //æ­£è§£ãƒ»ä¸æ­£è§£éŸ³é–¢æ•°
    //ãƒ”ãƒ³ãƒãƒ³éŸ³å‡ºã™
    function playPingPong() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      // ãƒ”ãƒ³éŸ³ï¼ˆé«˜ã‚ï¼‰
      const pin = ctx.createOscillator();
      pin.type = 'sine';
      pin.frequency.setValueAtTime(880, ctx.currentTime); // é«˜éŸ³
      pin.connect(ctx.destination);
      pin.start();
      pin.stop(ctx.currentTime + 0.2);

      // ãƒãƒ³éŸ³ï¼ˆä½ã‚ï¼‰
      const pong = ctx.createOscillator();
      pong.type = 'sine';
      pong.frequency.setValueAtTime(440, ctx.currentTime + 0.3); // ä½éŸ³
      pong.connect(ctx.destination);
      pong.start(ctx.currentTime + 0.3);
      pong.stop(ctx.currentTime + 0.5);
    }

    function playWrongSound() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      // ãƒ–éŸ³ï¼ˆä½ã‚ï¼‰
      const bu1 = ctx.createOscillator();
      bu1.type = 'square';
      bu1.frequency.setValueAtTime(220, ctx.currentTime); // ä½éŸ³
      bu1.connect(ctx.destination);
      bu1.start();
      bu1.stop(ctx.currentTime + 0.2);

      // ãƒ–éŸ³ï¼ˆã‚‚ã†ä¸€ç™ºï¼‰
      const bu2 = ctx.createOscillator();
      bu2.type = 'square';
      // åŒã˜éŸ³ã‚’å°‘ã—é…ã‚Œã¦
      bu2.frequency.setValueAtTime(220, ctx.currentTime + 0.3);
      bu2.connect(ctx.destination);
      bu2.start(ctx.currentTime + 0.3);
      bu2.stop(ctx.currentTime + 0.5);
    }


    const synth = window.speechSynthesis;
    const voiceSelect = document.getElementById("voiceSelect");

    // åˆ©ç”¨å¯èƒ½ãªå£°ã‚’èª­ã¿è¾¼ã‚€
    function loadVoices() {
      const voices = synth.getVoices();
      voiceSelect.innerHTML = "";

      voices.forEach((voice, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
    }

    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    // èª­ã¿ä¸Šã’å‡¦ç†
    function speak(text) {
      // recognition.stop();

      const rate = document.getElementById("rate").value;
      const selectedVoice = synth.getVoices()[voiceSelect.value];

      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = rate;
      utter.voice = selectedVoice;

      // utter.onend = () => {
      //   recognition.start();
      // };

      synth.speak(utter);
    }

    

          store.chart = new Chart(document.querySelector('#chart').getContext('2d'), {
            type: 'line',
            data: {
              labels: Array(100),
              datasets: [{
                label: 'Heart Rate (bpm)',
                backgroundColor: '#f55',
                borderColor: '#f55',
                fill: false,
                data: []
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              duration: 300,
              scales: {
                yAxes: [
                  {
                    ticks: {
                      min: 60,
                      max: 200,
                      stepSize: 10
                    }
                  }
                ]
              }
            }
          });

          function updateChart(newValue) {
            const chart = store.chart;
            const maxPoints = 100;

            // ãƒ©ãƒ™ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            chart.data.labels.push("");
            chart.data.datasets[0].data.push(newValue);

            // æœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å…ˆé ­ã‚’å‰Šé™¤
            if (chart.data.labels.length > maxPoints) {
              chart.data.labels.shift();
              chart.data.datasets[0].data.shift();
            }

            chart.update();
          }



    init();
  </script>


</body></html>